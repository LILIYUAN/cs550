/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */
#include <rpc/rpc.h>
#include <stdio.h>
#include <string.h>
#include <time.h>
#include <errno.h>
#include "obtain.h"

char localhostname[MAXHOSTNAME + 2];

/*
 * This routine queries the index-server to find the list of peers serving the
 * file rec->fname.
 */
int query_and_fetch(char *fname, char *index_svr, char *dest_dir, int fopt)
{
    query_req req;
    query_rec res_rec;
    CLIENT *clnt;
    bool_t ret;
    int res, i, attempts;
    time_t start_time, end_time;

    if ((clnt = clnt_create(index_svr, OBTAINPROG, OBTAINVER, "tcp")) == NULL) {
        clnt_pcreateerror(index_svr);
        return(-1);
    }

    printf("Created the client\n");
    /*
     * Copy the requested filename into the query record.
     */
    req.fname = fname;
    req.count = MAXCOUNT;

    printf("searching(%s) \n", req.fname);
    time(&start_time);
    ret = search_1(&req,&res_rec,clnt);
    time(&end_time);

    printf("Time taken by index server = %ld secs\n", (long) difftime(end_time, start_time));

    if (ret != RPC_SUCCESS) {
        printf("ret = %d\n", ret);
        clnt_perror (clnt, "call failed");
    }

    if (res_rec.count == 0) {
        printf("Failed to find any peers serving file : %s\n", req.fname);
        return (-1);
    }

    /*
     * Continue until the user enters a valid choice.
     */
    printf("Total number of peers serving %s = %d\n", res_rec.fname, res_rec.count);
    printf("Peers serving the file are :\n");
    for (i = 0; i < res_rec.count; i++) {
        printf("\t%d : %s\n", i, res_rec.recs[i].hostname);
    }

    if (fopt == 0) {
        printf("Pick the peer from which you want to fetch from : ");
        scanf("%d", &i);
        while (i < 0 || i >= res_rec.count) {
            printf("Pick a valid peer number : ");
            scanf("%d", &i);
        }
    } else {
        i = 0;
    }


    /*
     * We try to fetch the file untill we succeed or have tried all the servers.
     */
    attempts = 0;
    time(&start_time);
    while (get_file(res_rec.recs[i].hostname, fname, dest_dir) != 0 &&
        attempts < res_rec.count) {

        printf("Failed to fetch the file from host:%s\nTrying next server\n",
                res_rec.recs[i].hostname);

        i = (i + 1) % res_rec.count;
        attempts++;
        time(&start_time);
    }
    time(&end_time);

    if (attempts == res_rec.count) {
        printf("Failed to fetch the file from any of the listed peers\n");
    } else {
        printf("Time taken to fetch the file = %ld secs\n", (long) difftime(end_time, start_time));
    }

    clnt_destroy(clnt);

    return (0);
}

int
update(char *fname)
{
    update_req req;
    update_res res;
    CLIENT *clnt;

    if ((clnt = clnt_create(index_svr, OBTAINPROG, OBTAINVER, "tcp")) == NULL) {
        clnt_pcreateerror(index_svr);
        return(-1);
    }

    printf("Created the client\n");
    /*
     * Copy the requested filename into the query record.
     */
    req.fname = fname;

    printf("Requesting an update of file(%s) \n", req.fname);
    ret = update_1(&req,&res,clnt);

    printf("Time taken by index server = %ld secs\n", (long) difftime(end_time, start_time));

    if (ret != RPC_SUCCESS) {
        printf("ret = %d\n", ret);
        clnt_perror (clnt, "call failed");
    }

    printf("result = %d\n", res.res);

    clnt_destroy(clnt);

    return(res.res);
}

/*
 * usage
 */
void usage(char *name) {
    printf(" Usage : %s <file-name>\n", name);
    printf(" file-name : name of the file that you want to update\n");
}

int main(int argc, char *argv[])
{
    int result;
    int fopt = 0;
    int opt;

    if (argc != 2) {
        usage(argv[0]);
        return (1);
    }

    result = update(argv[1]);

    return 0;
}
